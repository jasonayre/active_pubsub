#!/usr/bin/env ruby

require 'thor'
require 'active_pubsub'
require './config/environment.rb'

class Subscriber < ::Thor
  desc "start", "Start ActivePubsub Subscriber"
  def start
    puts "Starting ActivePubsub Subscriber"

    ::ActivePubsub.load_subscribers

    ::ActivePubsub.start_subscribers

    puts "Subscribers Started"
    ::ActivePubsub.logger.info "Stopping Subscriber"
  end
end

#todo: write event loop that handles shutdown gracefully
#however, it seems that Bunny knows when to wake subscribers up
#so sleeping seems to be enough for now

::Subscriber.start

[:INT, :QUIT, :TERM].each do |signal|
  trap(signal) do
    ::ActivePubsub.logger.info "Stopping Subscriber"
    exit 0
  end
end

sleep
